#!/bin/sh
#
# @license   http://www.gnu.org/licenses/gpl.html GPL Version 3
# @author    Volker Theile <volker.theile@openmediavault.org>
# @author    OpenMediaVault Plugin Developers <plugins@omv-extras.org>
# @copyright Copyright (c) 2009-2013 Volker Theile
# @copyright Copyright (c) 2013-2016 OpenMediaVault Plugin Developers
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

AUTOSHUTDOWN_CONFIG="/etc/autoshutdown.conf"

xmlstarlet sel -t \
    -o "# This configuration file is auto-generated." -n \
    -o "# WARNING: Do not edit this file, your changes will be lost." -n \
    -m "//services/autoshutdown" \
        -i "enable = 0" -o "ENABLE=\"false\"" -n -b \
        -i "enable = 1" -o "ENABLE=\"true\"" -n -b \
        -v "concat('CYCLES=',cycles)" -n \
        -v "concat('SLEEP=',sleep)" -n \
        -o 'RANGE="' -v "range" -o '"' -n\
        -i "shutdowncommand = 0" -o "SHUTDOWNCOMMAND=\"shutdown -h now\"" -n -b \
        -i "shutdowncommand = 1" -o "SHUTDOWNCOMMAND=\"systemctl hibernate\"" -n -b \
        -i "shutdowncommand = 2" -o "SHUTDOWNCOMMAND=\"systemctl suspend\"" -n -b \
        -i "shutdowncommand = 3" -o "SHUTDOWNCOMMAND=\"systemctl hybrid\"" -n -b \
        -i "checkclockactive = 0" -o "CHECKCLOCKACTIVE=\"false\"" -n -b \
        -i "checkclockactive = 1" -o "CHECKCLOCKACTIVE=\"true\"" -n -b \
        -o 'UPHOURS="' -v "uphours-begin" -o '..' -v "uphours-end" -o '"' -n \
        -o 'NSOCKETNUMBERS="' -v "nsocketnumbers" -o '"' -n\
        -i "uldlcheck = 0" -o "ULDLCHECK=\"false\"" -n -b \
        -i "uldlcheck = 1" -o "ULDLCHECK=\"true\"" -n -b \
        -v "concat('ULDLRATE=',uldlrate)" -n \
        -i "loadaveragecheck = 0" -o "LOADAVERAGECHECK=\"false\"" -n -b \
        -i "loadaveragecheck = 1" -o "LOADAVERAGECHECK=\"true\"" -n -b \
        -v "concat('LOADAVERAGE=',loadaverage)" -n \
        -i "hddiocheck = 0" -o "HDDIOCHECK=\"false\"" -n -b \
        -i "hddiocheck = 1" -o "HDDIOCHECK=\"true\"" -n -b \
        -v "concat('HDDIO_RATE=',hddiorate)" -n \
        -i "checksamba = 0" -o "CHECK_SAMBA=\"false\"" -n -b \
        -i "checksamba = 1" -o "CHECK_SAMBA=\"true\"" -n -b \
        -i "checkcli = 0" -o "CHECK_CLI=\"false\"" -n -b \
        -i "checkcli = 1" -o "CHECK_CLI=\"true\"" -n -b \
        -i "syslog = 0" -o "SYSLOG=\"false\"" -n -b \
        -i "syslog = 1" -o "SYSLOG=\"true\"" -n -b \
        -i "verbose = 0" -o "VERBOSE=\"false\"" -n -b \
        -i "verbose = 1" -o "VERBOSE=\"true\"" -n -b \
        -i "fake = 0" -o "FAKE=\"false\"" -n -b \
        -i "fake = 1" -o "FAKE=\"true\"" -n -b \
        -i "string-length(extraoptions) > 0" -v "extraoptions" -n -b \
    -b \
    ${OMV_CONFIG_FILE} | xmlstarlet unesc > ${AUTOSHUTDOWN_CONFIG}
